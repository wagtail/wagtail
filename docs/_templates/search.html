{% extends "layout.html" %}
{% set title = _('Search') %}

{% block body %}
  <noscript>
  <div id="fallback" class="admonition warning">
    <p class="last">
      {% trans trimmed %}Please activate JavaScript to enable the search
      functionality.{% endtrans %}
    </p>
  </div>
  </noscript>

  <div id="search-results">
  </div>
{% endblock %}

{% block footer %}
{{ super() }}
<script>

function runSearchPageSearch(event) {
  const urlParams = new URLSearchParams(window.location.search)
  const query = urlParams.get('q')

  const searchResultsContainer = document.getElementById('search-results')
  addHeadingForQuery(query, searchResultsContainer)

  const docSearch = docSearchReady()
  const index = docSearch.client.initIndex('wagtail')
  index.search(
    query,
    {
      hitsPerPage: 100,
      facetFilters: [getVersionFacetFilter()]
    }
  )
  .then(({ hits }) => addResultsList(hits, searchResultsContainer))
  .catch((error) => console.log(error))
}

function addHeadingForQuery(query, parentElement) {
  const searchHeading = document.createElement('h2')
  searchHeading.textContent = `Search Results for "${query}"`
  parentElement.appendChild(searchHeading)
}

function addResultsList(hits, parentElement) {
  const searchResultsList = document.createElement('ul')
  searchResultsList.className = "search"
  for (hit of hits) {
    const hitElement = createHitElement(hit)
    searchResultsList.appendChild(hitElement)
  }
  parentElement.appendChild(searchResultsList)
}

function createHitElement(hitData) {
  console.log(hitData)
  const pageURL = extractPageLink(hitData.url)
  const anchor = hitData.anchor
  const result = hitData._highlightResult

  const hitListElement = document.createElement('li')

  let firstHierarchyLevel = undefined
  let lastHierarchyLevel = undefined
  for (levelLabel in result.hierarchy) {
    if (firstHierarchyLevel === undefined ) {
      firstHierarchyLevel = result.hierarchy[levelLabel]
    }
    lastHierarchyLevel = result.hierarchy[levelLabel]
  }

  const pageLink = document.createElement('a')
  hitListElement.appendChild(pageLink)
  pageLink.innerHTML = firstHierarchyLevel.value
  pageLink.href = pageURL

  const contextElement = document.createElement('div')
  hitListElement.appendChild(contextElement)
  contextElement.className = 'context'

  console.log(lastHierarchyLevel)
  if (lastHierarchyLevel && lastHierarchyLevel !== firstHierarchyLevel ) {
    const contextLinkContainer = document.createElement('div')
    contextElement.appendChild(contextLinkContainer)
    const contextLink = document.createElement('a')
    contextLinkContainer.appendChild(contextLink)
    contextLink.innerHTML = lastHierarchyLevel.value
    contextLink.href = pageURL + '#' + anchor
  }

  if (result.content) {
    const contentElement = document.createElement('div')
    contentElement.innerHTML = result.content.value
    contextElement.appendChild(contentElement)
  }

  return hitListElement
}

function extractPageLink(url) {
  const endPageUrlIndex = url.lastIndexOf('#')
  return url.slice(0, endPageUrlIndex)
}

function getElementTypeForHierarchyLevelLabel(level) {
  const elementTypes = {
    'lvl0': 'h3',
    'lvl1': 'h4',
    'lvl2': 'span',
    'lvl3': 'span',
    'lvl4': 'span',
    'lvl5': 'span',
    'lvl6': 'span',
  }
  return elementTypes[level]
}

window.onload = runSearchPageSearch
</script>
{% endblock %}