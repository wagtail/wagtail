{% load i18n %}
<table class="listing">
    {% if can_delete_snippets %}<col width="5%" />{% endif %}
    <col />
    <col />
    <col width="16%" />
    <thead>
        <tr class="table-headers">
            {% if can_delete_snippets %}<th><input type="checkbox" class="toggle-select-all"/></th>{% endif %}
            <th>{% trans "Title" %}</th>
        </tr>
    </thead>
    <tbody>
        {% for snippet in items %}
            <tr>
                {% if can_delete_snippets %}<td class="select"><input type="checkbox" class="toggle-select-row" id="{{ snippet.id }}"/></td>{% endif %}
                <td class="title">
                    {% if choosing %}
                        <h2><a class="snippet-choice" href="{% url 'wagtailsnippets:chosen' model_opts.app_label model_opts.model_name snippet.id %}">{{ snippet }}</a></h2>
                    {% else %}
                        <h2><a href="{% url 'wagtailsnippets:edit' model_opts.app_label model_opts.model_name snippet.id %}">{{ snippet }}</a></h2>
                    {% endif %}
                </td>
            </tr>
        {% endfor %}
    </tbody>
</table>
{# need to check where this should actually go #}
{# need to ensure it works when you go 'back' #}
{# need to ensure it all works when you are viewing search results #}
<script>
  $( document ).ready(function() {
      $('table.listing input[type="checkbox"]').on('click', function(event) {
          $target = $(event.target);
          value = $target.prop('checked');
          if ( $target.hasClass('toggle-select-row') ) {
              $row = $($target.closest('tr')[0]);
              $selectAllCheckbox = $('table.listing input[type="checkbox"].toggle-select-all');
              if (value === true) {
                  $row.addClass('selected');
                  unchekedCheckboxes = $('table.listing tbody input[type="checkbox"]:not(:checked)').length;
                  if (unchekedCheckboxes === 0) {
                      $selectAllCheckbox.prop('checked', false);
                  }
              } else {
                  $row.removeClass('selected');
                  $selectAllCheckbox.prop('checked', false);
              }
          } else if ( $target.hasClass('toggle-select-all') ) {
              $rows = $('table.listing tr');
              $checkboxes = $('table.listing input[type="checkbox"]');
              if (value === true) {
                  $rows.addClass('selected');
                  $checkboxes.prop('checked', true);
              } else {
                  $rows.removeClass('selected');
                  $checkboxes.prop('checked', false);
              }
          }
          var $chekedCheckboxes = $('table.listing tbody input[type="checkbox"]:checked');
          var $deleteButton = $('a.button.delete-button');
          var ids = [];
          $.map($chekedCheckboxes, function(checkbox) {
              ids.push(checkbox.id);
          })
          if ( ids.length === 0 ) {
              $deleteButton.addClass('disabled');
              $deleteButton.attr('href', null);
          } else {
              $deleteButton.removeClass('disabled');
              var url = $deleteButton.data('url');
              url = url + $.param({id: ids}, true);
              $deleteButton.attr('href', url);
          }
      });
  });
</script>
