{% extends "layout.html" %}
{% set title = _('Search') %}

{% block body %}
  <noscript>
  <div id="fallback" class="admonition warning">
    <p class="last">
      {% trans trimmed %}Please activate JavaScript to enable the search
      functionality.{% endtrans %}
    </p>
  </div>
  </noscript>

  <div id="search-results">
  </div>

  <nav id="pagination" role="navigation" aria-label="pagination">
    <button class="pagination-previous">Previous</button>
    <ul class="pagination-list"></ul>
    <button class="pagination-next">Next</button>
  </nav>
{% endblock %}

{% block footer %}
{{ super() }}
<script>

function runSearchPageSearch(event, page=0) {
  const urlParams = new URLSearchParams(window.location.search)
  const query = urlParams.get('q')

  const searchResultsContainer = document.getElementById('search-results')

  // Erase previous results
  searchResultsContainer.innerHTML = ""
  document.querySelector('.pagination-list').innerHTML = ""
  addHeadingForQuery(query, searchResultsContainer)

  const hitsPerPage = 10
  const docSearch = docSearchReady()
  const index = docSearch.client.initIndex('wagtail')
  index.search(
    query,
    {
      page: page,
      hitsPerPage: hitsPerPage,
      facetFilters: [getVersionFacetFilter()]
    }
  )
  .then(result => {
    // Display pagination if more than 1 page returned
    document.querySelector("#pagination").style.display = "none"
    let nbPages = result["nbPages"] 
    if (nbPages > 1) {
      document.querySelector("#pagination").style.display = "flex"
      displayPagination(page, nbPages)
    }

    // Display hits
    let hits = result["hits"]
    addResultsList(hits, query, searchResultsContainer)
  })
  .catch((error) => console.log(error))
}

function displayPagination(page, totalPages) {
  const paginationDiv = document.querySelector("#pagination")
  const paginationList = paginationDiv.querySelector(".pagination-list")
  
  // Disable previous/next button if showing first/last page
  paginationDiv.querySelector(".pagination-previous").disabled = false
  if (page == 0) {
    paginationDiv.querySelector(".pagination-previous").disabled = true
  }
  paginationDiv.querySelector(".pagination-next").disabled = false
  if (page == totalPages - 1) {
    paginationDiv.querySelector(".pagination-next").disabled = true
  } 

  // Display at most "toBeDisplayed" page links in the paginator
  const toBeDisplayed = 10
  let [start, end] = setStartEndForPaginator(page, totalPages, toBeDisplayed)

  for (let i = start; i < end; i++) {
    let newPaginationItem = document.createElement("li")
    let newPaginationLink = document.createElement("a")
    newPaginationLink.classList.add("pagination-link")
    newPaginationLink.innerHTML = i + 1
    if (i == page) {
        newPaginationLink.setAttribute("aria-label", `page ${i+1}`)
        newPaginationLink.setAttribute("aria-current", `page`)
        newPaginationLink.classList.add("is-current")
    } else {
        newPaginationLink.setAttribute("aria-label", `Go to page ${i+1}`)
    }

    // Register event handlers
    newPaginationLink.onclick = function(event) {
        runSearchPageSearch(event, page=i)
    };
    paginationDiv.querySelector(".pagination-previous").onclick = function(event) {
        runSearchPageSearch(event, page=page - 1)
    };
    paginationDiv.querySelector(".pagination-next").onclick = function(event) {
        runSearchPageSearch(event, page=page + 1)
    };

    newPaginationItem.append(newPaginationLink)
    paginationList.append(newPaginationItem)
  }
}

function setStartEndForPaginator(currentPage, totalPages, nbPagesLinkToDisplay) {
  let start = 0
  let end = totalPages

  if (totalPages > nbPagesLinkToDisplay) {
    start = currentPage

    if (totalPages - currentPage < nbPagesLinkToDisplay) {
      start = totalPages - nbPagesLinkToDisplay
    } 
    
    if (totalPages - start > nbPagesLinkToDisplay) {
      end = currentPage + nbPagesLinkToDisplay
    }
  }

  return [start, end]
}

function addHeadingForQuery(query, parentElement) {
  const searchHeading = document.createElement('h1')
  searchHeading.textContent = `Search results for “${query}”`
  parentElement.appendChild(searchHeading)
}

function addResultsList(hits, query, parentElement) {
  const searchResultsList = document.createElement('ul')
  searchResultsList.className = "search"
  for (hit of hits) {
    const hitElement = createHitElement(hit, query)
    searchResultsList.appendChild(hitElement)
  }
  parentElement.appendChild(searchResultsList)
}

function createHitElement(hitData, query) {
  const pageURL = new URL(hitData.url)
  pageURL.hash = '';
  pageURL.searchParams.set('highlight', query);
  const anchorURL = new URL(hitData.url);
  anchorURL.searchParams.set('highlight', query);
  const result = hitData._highlightResult

  const hitListElement = document.createElement('li')

  const hierarchies = Object.values(result.hierarchy);
  const firstHierarchyLevel = hierarchies[0];
  const lastHierarchyLevel = hierarchies[hierarchies.length - 1];

  const pageLink = document.createElement('a')
  hitListElement.appendChild(pageLink)
  pageLink.innerHTML = firstHierarchyLevel.value
  pageLink.href = pageURL

  const contextElement = document.createElement('div')
  hitListElement.appendChild(contextElement)
  contextElement.className = 'context'

  if (lastHierarchyLevel && lastHierarchyLevel !== firstHierarchyLevel ) {
    const contextLinkContainer = document.createElement('div')
    contextElement.appendChild(contextLinkContainer)
    const contextLink = document.createElement('a')
    contextLinkContainer.appendChild(contextLink)
    contextLink.innerHTML = lastHierarchyLevel.value
    contextLink.href = anchorURL
  }

  if (result.content) {
    const contentElement = document.createElement('div')
    contentElement.innerHTML = result.content.value
    contextElement.appendChild(contentElement)
  }

  return hitListElement
}

window.addEventListener('DOMContentLoaded', runSearchPageSearch)
</script>
{% endblock %}
